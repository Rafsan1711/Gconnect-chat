<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GConnect Chat App</title>
  <style>
    /* (আপনার আগের স্টাইল বজায় রেখে একটু সংক্ষিপ্তকরণ) */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Helvetica Neue',Arial,sans-serif;background:#121c21;color:#e1e1e1;height:100vh}
    .app{display:flex;height:100%}
    .sidebar{width:30%;background:#242f34;border-right:1px solid #333;display:flex;flex-direction:column;padding-bottom:12px}
    #header{background:#075e54;color:#fff;padding:16px;display:flex;justify-content:space-between;align-items:center}
    #loginBtn{margin:12px;padding:12px;background:#25d366;border:none;border-radius:4px;cursor:pointer;color:#000}
    #userInfo{margin:0 12px 12px;font-size:.9rem;color:#ccc}
    #searchInput{margin:0 12px;padding:8px;width:calc(100% - 24px);border-radius:20px;border:1px solid #333;background:#121c21;color:#e1e1e1}
    .list-title{margin:12px;font-weight:bold;color:#ccc}
    .chatlist{flex:1;overflow-y:auto;margin-top:8px}
    .user-item{display:flex;align-items:center;padding:12px;border-bottom:1px solid #333;cursor:pointer}
    .user-item:hover{background:#2a343b}
    .avatar{width:36px;height:36px;border-radius:50%;background:#555;margin-right:12px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .status-dot{width:10px;height:10px;border-radius:50%;position:absolute;bottom:2px;right:2px;border:2px solid #242f34}
    .online{background:#00e676}.offline{background:#757575}
    .name{font-size:1rem;flex:1}

    .chat-section{width:70%;display:flex;flex-direction:column;background:#111b21}
    #chatHeader{background:#498fe0;color:#fff;padding:12px 16px;display:flex;align-items:center;position:relative}
    #chatHeader .avatar{width:32px;height:32px;border-radius:50%;background:#555;margin-right:12px;overflow:hidden}
    #messages{flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column}
    .message{max-width:70%;margin-bottom:12px;padding:10px 12px;border-radius:8px;word-wrap:break-word}
    .incoming{background:#2a2f32;align-self:flex-start;border-radius:0 8px 8px 8px}
    .outgoing{background:#056162;align-self:flex-end;border-radius:8px 0 8px 8px;color:#e1e1e1}
    .sender-line{display:flex;align-items:center;margin-bottom:6px}
    .sender{font-size:.85rem;color:#ccc;margin-right:8px}
    .sender-pic{width:24px;height:24px;border-radius:50%}
    .input-area{display:flex;padding:12px;background:#2a343b}
    #messageInput{flex:1;padding:10px;border-radius:20px;border:1px solid #333;background:#121c21;color:#e1e1e1}
    #sendBtn{margin-left:8px;width:40px;height:40px;border:none;border-radius:50%;background:#128c7e;color:#fff;font-size:1.1rem;cursor:pointer}

    .reply-preview{background:#1d2c32;border-left:4px solid #25d366;padding:6px 12px;margin-bottom:6px;color:#ccc;border-radius:6px}
    @media (max-width:600px){ .sidebar{width:100%;height:100vh;border-bottom:1px solid #333} .chat-section{width:100%;height:100vh;display:none} #backBtn{display:block} }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div id="header">GConnect <div style="display:flex;align-items:center"></div></div>
      <button id="loginBtn">Sign in with Google</button>
      <div id="userInfo"></div>
      <input id="searchInput" placeholder="Search chats..." />
      <div class="list-title">Chats</div>
      <div id="chatList" class="chatlist"></div>
    </div>

    <div class="chat-section">
      <div id="chatHeader">
        <div class="avatar" id="chatHeaderAvatar"></div>
        <span id="chatName">Select a chat</span>
      </div>
      <div id="messages"></div>
      <div class="input-area">
        <div id="replyPreview" class="reply-preview" style="display:none"><span id="replyText"></span><button onclick="cancelReply()" style="margin-left:8px">×</button></div>
        <input id="messageInput" placeholder="Type a message..." disabled />
        <button id="sendBtn" disabled>✈</button>
      </div>
    </div>
  </div>

  <!-- Firebase client -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    /********** CONFIGURE THIS (replace SERVER_BASE with your Render backend URL) **********/
    const SERVER_BASE = "https://REPLACE_WITH_YOUR_RENDER_URL"; // <<--- change this to your Render URL
    /***************************************************************************************/
    // Inline "verified" SVG as data URL so no external image files are needed
    const VERIFIED_DATA_URL = 'data:image/svg+xml;utf8,' + encodeURIComponent(
      '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#2DA44E"/><path d="M9.5 12.8l1.9 1.9 4.1-5" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>'
    );

    // Firebase client config (your existing config - replace if you use another project)
    const firebaseConfig = {
      apiKey: "AIzaSyAGs_lp4BbEWyywxRx1DuQMlrKQ2AiuHY0",
      authDomain: "gconnect-387da.firebaseapp.com",
      databaseURL: "https://gconnect-387da-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gconnect-387da",
      storageBucket: "gconnect-387da.firebasestorage.app",
      messagingSenderId: "156103622971",
      appId: "1:156103622971:web:fa6a2f8f21c9a24f6bb71e",
      measurementId: "G-BR9WKZLV1D"
    };

    // initialize
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.database();

    // Elements
    const loginBtn = document.getElementById('loginBtn');
    const userInfoEl = document.getElementById('userInfo');
    const chatList = document.getElementById('chatList');
    const chatNameEl = document.getElementById('chatName');
    const chatHeaderAvatar = document.getElementById('chatHeaderAvatar');
    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    let currentUser = null;
    let currentChatId = null;
    let replyTo = null;

    // Sign-in
    loginBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loginBtn.style.display = 'none';
        userInfoEl.textContent = `Logged in as ${user.displayName}`;
        if (user.photoURL) {
          const img = document.createElement('img'); img.src = user.photoURL; img.style.width='28px'; img.style.height='28px'; img.style.borderRadius='50%'; img.style.marginRight='8px';
          userInfoEl.prepend(img);
        }
        // write presence
        db.ref('users/' + user.uid).set({ uid: user.uid, name: user.displayName, photoURL: user.photoURL || '', online: true });
        db.ref('users/' + user.uid + '/online').onDisconnect().set(false);
        loadChats();
      } else {
        currentUser = null;
        loginBtn.style.display = 'inline-block';
        userInfoEl.textContent = '';
        loadChats(); // still show bot entry even if not logged in
      }
    });

    // Load users from DB & show in chatlist, then add bot
    function loadChats() {
      chatList.innerHTML = '';
      db.ref('users').once('value').then(snap => {
        snap.forEach(uSnap => {
          const u = uSnap.val();
          if (!u || !u.uid) return;
          if (currentUser && u.uid === currentUser.uid) return; // skip yourself
          const div = document.createElement('div');
          div.className = 'user-item';
          div.dataset.uid = u.uid;
          div.innerHTML = `<div class="avatar"><img src="${u.photoURL||''}" /><span class="status-dot ${u.online?'online':'offline'}"></span></div><div class="name">${u.name}</div>`;
          div.onclick = () => openChat([u]);
          chatList.appendChild(div);
        });
        // add bot AFTER listing other users
        addGconnectBot();
      }).catch(err=>{
        console.error('loadChats error', err);
        addGconnectBot();
      });
    }

    // Add custom bot entry
    function addGconnectBot() {
      if (document.querySelector('[data-uid="gconnect_bot"]')) return;
      const div = document.createElement('div');
      div.className = 'user-item';
      div.dataset.uid = 'gconnect_bot';
      div.innerHTML = `<div class="avatar"><img src="${VERIFIED_DATA_URL}" /><span class="status-dot online"></span></div><div class="name">GConnect</div>`;
      div.onclick = () => openGconnectChat();
      chatList.insertBefore(div, chatList.firstChild);
    }

    // Open normal one-on-one chat
    function openChat(users, gid = null) {
      const other = users[0];
      currentChatId = gid || [ (currentUser ? currentUser.uid : 'anon'), other.uid ].sort().join('_');
      chatNameEl.textContent = other.name;
      chatHeaderAvatar.innerHTML = `<img src="${other.photoURL||VERIFIED_DATA_URL}" style="width:32px;height:32px;border-radius:50%"/>`;
      messageInput.disabled = false; sendBtn.disabled = false;
      loadMessages();
    }

    // Open bot chat
    function openGconnectChat() {
      currentChatId = [ (currentUser ? currentUser.uid : 'anon'), 'gconnect_bot' ].sort().join('_');
      chatNameEl.textContent = 'GConnect';
      chatHeaderAvatar.innerHTML = `<img src="${VERIFIED_DATA_URL}" style="width:32px;height:32px;border-radius:50%"/>`;
      messageInput.disabled = false; sendBtn.disabled = false;
      loadMessages();
    }

    // Load messages
    function loadMessages() {
      messagesEl.innerHTML = '';
      const path = `chats/${currentChatId}`;
      db.ref(path).off();
      db.ref(path).on('value', snap => {
        messagesEl.innerHTML = '';
        snap.forEach(mSnap => {
          const m = mSnap.val();
          const mine = currentUser && m.senderId === currentUser.uid;
          const div = document.createElement('div');
          div.className = 'message ' + (mine ? 'outgoing' : 'incoming');
          div.innerHTML = `<div class="sender-line"><div class="sender">${escapeHtml(m.senderName)}</div></div><div>${escapeHtml(m.text||'')}</div>`;
          messagesEl.appendChild(div);
        });
        messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });
      });
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    // send message: behaves normally for regular chats; for bot chat it calls backend API then pushes bot reply
    sendBtn.onclick = async () => {
      const txt = messageInput.value.trim(); if(!txt) return;
      if(!currentUser){ alert('Please sign in with Google to chat.'); return; }

      const path = `chats/${currentChatId}`;
      const msg = { senderId: currentUser.uid, senderName: currentUser.displayName, senderPic: currentUser.photoURL||'', text: txt, timestamp: Date.now(), status: 'Sent' };
      const ref = await db.ref(path).push(msg);
      messageInput.value = '';

      // if this is gconnect_bot chat -> call backend proxy
      if (currentChatId.includes('gconnect_bot')) {
        // show a local temporary "typing" message
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message incoming';
        typingDiv.textContent = 'GConnect is typing...';
        messagesEl.appendChild(typingDiv);
        messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' });

        try {
          const payload = {
            messages: [{ role: "user", content: txt }],
            model: "openai/gpt-oss-120b:together"
          };
          const resp = await fetch(`${SERVER_BASE}/api/query`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const json = await resp.json();
          typingDiv.remove();

          const replyText = json.replyText || (json.result && (json.result.choices?.[0]?.message?.content || json.result.output?.[0]?.content)) || "Sorry, bot didn't respond.";
          await db.ref(path).push({ senderId: 'gconnect_bot', senderName: 'GConnect', senderPic: VERIFIED_DATA_URL, text: replyText, timestamp: Date.now(), status: 'Sent' });
        } catch (err) {
          console.error('Bot proxy error', err);
          typingDiv.remove();
          await db.ref(path).push({ senderId: 'gconnect_bot', senderName: 'GConnect', senderPic: VERIFIED_DATA_URL, text: 'Bot unavailable right now.', timestamp: Date.now(), status: 'Sent' });
        }
      }
    };

    messageInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendBtn.click(); });

    // Initialize: show bot entry even before login
    document.addEventListener('DOMContentLoaded', ()=> { loadChats(); addGconnectBot(); });
  </script>
</body>
        </html>
